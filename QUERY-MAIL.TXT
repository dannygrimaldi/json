WITH consulta_1 AS (
    SELECT
        FECHA_RECEPCION,
        agencia,
        ROW_NUMBER() OVER (PARTITION BY agencia ORDER BY FECHA_RECEPCION) AS rn
    FROM
        CONTROL_MAIL
)
SELECT
    COALESCE(a.rn, b.rn) AS rn,
    a.FECHA_RECEPCION AS MUNOZ,
    b.FECHA_RECEPCION AS STO
FROM
    (SELECT FECHA_RECEPCION, rn FROM consulta_1 WHERE agencia = 'MUNOZ') a
FULL OUTER JOIN
    (SELECT FECHA_RECEPCION, rn FROM consulta_1 WHERE agencia = 'STO') b
ON
    a.rn = b.rn
ORDER BY
    rn;




WITH consulta_1 AS (
    SELECT
        FECHA_RECEPCION,
        NOMBRE_ARCHIVO,
        agencia,
        ROW_NUMBER() OVER (PARTITION BY agencia ORDER BY FECHA_RECEPCION) AS rn
    FROM
        CONTROL_MAIL
)
SELECT
    COALESCE(a.rn, b.rn) AS rn,
    a.FECHA_RECEPCION AS MUNOZ_FECHA_RECEPCION,
    a.NOMBRE_ARCHIVO AS MUNOZ_NOMBRE_ARCHIVO,
    b.FECHA_RECEPCION AS STO_FECHA_RECEPCION,
    b.NOMBRE_ARCHIVO AS STO_NOMBRE_ARCHIVO
FROM
    (SELECT FECHA_RECEPCION, NOMBRE_ARCHIVO, rn FROM consulta_1 WHERE agencia = 'MUNOZ') a
FULL OUTER JOIN
    (SELECT FECHA_RECEPCION, NOMBRE_ARCHIVO, rn FROM consulta_1 WHERE agencia = 'STO') b
ON
    a.rn = b.rn
ORDER BY
    rn;







WITH consulta_1 AS (
    SELECT
        FECHA_RECEPCION,
        NOMBRE_ARCHIVO,
        CASE 
            WHEN NOMBRE_ARCHIVO LIKE '%MUNOZ%' AND NOMBRE_ARCHIVO LIKE '%1%' THEN 'BLOQUE 1 MUNOZ'
            WHEN NOMBRE_ARCHIVO LIKE '%MUNOZ%' AND NOMBRE_ARCHIVO LIKE '%2%' THEN 'BLOQUE 2 MUNOZ'
            WHEN NOMBRE_ARCHIVO LIKE '%MUNOZ%' AND NOMBRE_ARCHIVO LIKE '%3%' THEN 'BLOQUE 3 MUNOZ'
            WHEN NOMBRE_ARCHIVO LIKE '%STO%' AND NOMBRE_ARCHIVO LIKE '%1%' THEN 'BLOQUE 1 STO'
            WHEN NOMBRE_ARCHIVO LIKE '%STO%' AND NOMBRE_ARCHIVO LIKE '%2%' THEN 'BLOQUE 2 STO'
            WHEN NOMBRE_ARCHIVO LIKE '%STO%' AND NOMBRE_ARCHIVO LIKE '%3%' THEN 'BLOQUE 3 STO'
            ELSE NOMBRE_ARCHIVO
        END AS BLOQUE,
        ROW_NUMBER() OVER (PARTITION BY 
            CASE 
                WHEN NOMBRE_ARCHIVO LIKE '%MUNOZ%' AND NOMBRE_ARCHIVO LIKE '%1%' THEN 'BLOQUE 1 MUNOZ'
                WHEN NOMBRE_ARCHIVO LIKE '%MUNOZ%' AND NOMBRE_ARCHIVO LIKE '%2%' THEN 'BLOQUE 2 MUNOZ'
                WHEN NOMBRE_ARCHIVO LIKE '%MUNOZ%' AND NOMBRE_ARCHIVO LIKE '%3%' THEN 'BLOQUE 3 MUNOZ'
                WHEN NOMBRE_ARCHIVO LIKE '%STO%' AND NOMBRE_ARCHIVO LIKE '%1%' THEN 'BLOQUE 1 STO'
                WHEN NOMBRE_ARCHIVO LIKE '%STO%' AND NOMBRE_ARCHIVO LIKE '%2%' THEN 'BLOQUE 2 STO'
                WHEN NOMBRE_ARCHIVO LIKE '%STO%' AND NOMBRE_ARCHIVO LIKE '%3%' THEN 'BLOQUE 3 STO'
                ELSE NOMBRE_ARCHIVO
            END
            ORDER BY FECHA_RECEPCION) AS rn
    FROM
        CONTROL_MAIL
)
SELECT
    COALESCE(a.rn, b.rn, c.rn, d.rn, e.rn, f.rn) AS rn,
    a.NOMBRE_ARCHIVO AS MUNOZ_BLOQUE_1,
    b.NOMBRE_ARCHIVO AS MUNOZ_BLOQUE_2,
    c.NOMBRE_ARCHIVO AS MUNOZ_BLOQUE_3,
    d.NOMBRE_ARCHIVO AS STO_BLOQUE_1,
    e.NOMBRE_ARCHIVO AS STO_BLOQUE_2,
    f.NOMBRE_ARCHIVO AS STO_BLOQUE_3
FROM
    (SELECT FECHA_RECEPCION, NOMBRE_ARCHIVO, rn FROM consulta_1 WHERE BLOQUE = 'BLOQUE 1 MUNOZ') a
FULL OUTER JOIN
    (SELECT FECHA_RECEPCION, NOMBRE_ARCHIVO, rn FROM consulta_1 WHERE BLOQUE = 'BLOQUE 2 MUNOZ') b
ON a.rn = b.rn
FULL OUTER JOIN
    (SELECT FECHA_RECEPCION, NOMBRE_ARCHIVO, rn FROM consulta_1 WHERE BLOQUE = 'BLOQUE 3 MUNOZ') c
ON a.rn = c.rn
FULL OUTER JOIN
    (SELECT FECHA_RECEPCION, NOMBRE_ARCHIVO, rn FROM consulta_1 WHERE BLOQUE = 'BLOQUE 1 STO') d
ON a.rn = d.rn OR b.rn = d.rn OR c.rn = d.rn
FULL OUTER JOIN
    (SELECT FECHA_RECEPCION, NOMBRE_ARCHIVO, rn FROM consulta_1 WHERE BLOQUE = 'BLOQUE 2 STO') e
ON a.rn = e.rn OR b.rn = e.rn OR c.rn = e.rn
FULL OUTER JOIN
    (SELECT FECHA_RECEPCION, NOMBRE_ARCHIVO, rn FROM consulta_1 WHERE BLOQUE = 'BLOQUE 3 STO') f
ON a.rn = f.rn OR b.rn = f.rn OR c.rn = f.rn
ORDER BY
    rn;
